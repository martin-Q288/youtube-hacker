import streamlit as st
import google.generativeai as genai
from PIL import Image

# ---------------------------------------------------------
# 1. í˜ì´ì§€ ì„¤ì •
# ---------------------------------------------------------
st.set_page_config(page_title="ì‡¼ì¸  ë¶„ì„í‘œ ì§„ë‹¨ê¸° (Gemini 3.0)", page_icon="ğŸ“Š", layout="wide")

# ---------------------------------------------------------
# 2. ì‚¬ì´ë“œë°”: êµ¬ê¸€ API í‚¤ ì…ë ¥
# ---------------------------------------------------------
with st.sidebar:
    st.header("âš™ï¸ ì„¤ì •")
    api_key = st.text_input("Google Gemini API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”", type="password")
    st.info("êµ¬ê¸€ AI Studioì—ì„œ ë°›ì€ ë¬´ë£Œ í‚¤ë¥¼ ë„£ìœ¼ì„¸ìš”.")
    st.markdown("---")
    st.write("Powered by **Gemini 3.0 Pro** (Latest)")

# êµ¬ê¸€ AI ì„¤ì •
if api_key:
    genai.configure(api_key=api_key)
else:
    st.warning("ğŸ‘ˆ ì™¼ìª½ ì‚¬ì´ë“œë°”ì— Google API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!")
    st.stop()

# ---------------------------------------------------------
# 3. ë©”ì¸ í™”ë©´
# ---------------------------------------------------------
st.title("ğŸ“Š ìœ íŠœë¸Œ ì‡¼í•‘ ì‡¼ì¸  ì •ë°€ ì§„ë‹¨ê¸° (v3.0)")
st.markdown("### ìŠ¤íŠœë””ì˜¤ ë¶„ì„í‘œë¥¼ ë˜ì ¸ì£¼ì„¸ìš”. **Gemini 3.0**ì´ ëƒ‰ì •í•˜ê²Œ íŒë‹¨í•©ë‹ˆë‹¤.")
st.caption("â€» 2025ë…„ 11ì›” ì¶œì‹œëœ ìµœì‹  `gemini-3-pro-preview` ëª¨ë¸ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.")
st.markdown("---")

# íŒŒì¼ ì—…ë¡œë” (ëŒ€ëŸ‰ ê°€ëŠ¥)
uploaded_files = st.file_uploader(
    "ë¶„ì„í•  ìº¡ì²˜ ì´ë¯¸ì§€ë¥¼ ëª¨ë‘ ë“œë˜ê·¸í•´ì„œ ë„£ìœ¼ì„¸ìš” (20ì¥ ì´ìƒ ê°€ëŠ¥)", 
    type=["jpg", "png", "jpeg"], 
    accept_multiple_files=True
)

if uploaded_files:
    st.success(f"ğŸ“¸ ì´ {len(uploaded_files)}ì¥ì˜ ë¶„ì„í‘œê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.")
    
    # ë¶„ì„ ì‹œì‘ ë²„íŠ¼
    if st.button("ğŸš€ Gemini 3.0ìœ¼ë¡œ ì§„ë‹¨ ì‹œì‘", type="primary"):
        
        # ì§„í–‰ ìƒí™©ë°”
        progress_text = "Gemini 3.0ì´ ë°ì´í„°ë¥¼ ì‹¬ì¸µ ì¶”ë¡  ì¤‘ì…ë‹ˆë‹¤..."
        my_bar = st.progress(0, text=progress_text)
        
        # ì´ë¯¸ì§€ í•˜ë‚˜ì”© ìˆœì„œëŒ€ë¡œ ë¶„ì„
        for i, uploaded_file in enumerate(uploaded_files):
            
            with st.expander(f"ğŸ“„ {i+1}ë²ˆì§¸ ì˜ìƒ ë¶„ì„ ê²°ê³¼ ({uploaded_file.name})", expanded=True):
                col_img, col_report = st.columns([1, 1.5])
                
                # ì™¼ìª½: ì´ë¯¸ì§€ ë³´ì—¬ì£¼ê¸°
                image = Image.open(uploaded_file)
                with col_img:
                    st.image(image, caption=f"ì—…ë¡œë“œëœ ë¶„ì„í‘œ {i+1}", use_column_width=True)
                
                # ì˜¤ë¥¸ìª½: ë¶„ì„ ê²°ê³¼
                with col_report:
                    with st.spinner("Gemini 3.0ì´ ì‚¬ê³ (Thinking)í•˜ëŠ” ì¤‘..."):
                        try:
                            # ğŸ”¥ ëª¨ë¸ì„ ìµœì‹  3.0 Pro ë²„ì „ìœ¼ë¡œ êµì²´!
                            model = genai.GenerativeModel('gemini-3-pro-preview')
                            
                            # ë¶„ì„ í”„ë¡¬í”„íŠ¸ (3.0ì˜ ì¶”ë¡  ëŠ¥ë ¥ì„ í™œìš©)
                            vision_prompt = """
                            ë‹¹ì‹ ì€ ìœ íŠœë¸Œ ì‡¼í•‘ ì•Œê³ ë¦¬ì¦˜ ìµœê³  ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
                            ì´ ì´ë¯¸ì§€ëŠ” ìœ íŠœë¸Œ ìŠ¤íŠœë””ì˜¤ì˜ 'ë„ë‹¬ ë²”ìœ„' ë° 'ì°¸ì—¬ë„' ê·¸ë˜í”„ì…ë‹ˆë‹¤.
                            
                            Gemini 3.0ì˜ ê°•ë ¥í•œ ì¶”ë¡  ëŠ¥ë ¥ì„ ì‚¬ìš©í•˜ì—¬, ë‹¤ìŒ í•­ëª©ì„ ë¶„ì„í•´ì£¼ì„¸ìš”:

                            1. **ğŸš¦ íŠ¸ë˜í”½ ì†ŒìŠ¤ íŒë…**:
                               - 'ì‡¼ì¸  í”¼ë“œ(Feed)' vs 'íƒìƒ‰/ê²€ìƒ‰(Browse)' ë¹„ìœ¨ì„ ìˆ«ìë¡œ í™•ì¸í•˜ì„¸ìš”.
                               - íƒìƒ‰ ë¹„ì¤‘ì´ ë†’ìœ¼ë©´ 'êµ¬ë§¤ ì˜ë„ ë†’ìŒ', í”¼ë“œ ë¹„ì¤‘ì´ ë†’ìœ¼ë©´ 'ë‹¨ìˆœ ë…¸ì¶œ'ë¡œ íŒë‹¨í•˜ì„¸ìš”.

                            2. **ğŸ“‰ ê·¸ë˜í”„ ì´íƒˆ êµ¬ê°„ ì°¾ê¸°**:
                               - ì‹œì²­ ì§€ì† ì‹œê°„ ê·¸ë˜í”„ê°€ ì´ˆë°˜(3ì´ˆ ì´ë‚´)ì— êº¾ì´ëŠ”ì§€, ì™„ë§Œí•˜ê²Œ ìœ ì§€ë˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.
                               - 30ì´ˆ ì´í›„ê¹Œì§€ í‰íƒ„í•˜ë‹¤ë©´ 'ì‡¼í•‘ ì„¤ë“ë ¥ ìˆìŒ'ìœ¼ë¡œ í‰ê°€í•˜ì„¸ìš”.

                            3. **ğŸ’° ì‡¼í•‘ ì í•©ë„ ë“±ê¸‰ ë§¤ê¸°ê¸°**:
                               - ì¡°íšŒìˆ˜ ëŒ€ë¹„ ìˆ˜ìµì´ ì¢‹ì€ì§€ ë‚˜ìœì§€, í˜¹ì€ ì ì¬ë ¥ì´ ìˆëŠ”ì§€ í‰ê°€í•˜ì—¬ [S/A/B/C/F] ë“±ê¸‰ì„ ë§¤ê¸°ì„¸ìš”.

                            4. **âš¡ï¸ ë‹¥í„°ì˜ ì§ì„¤ì  ì²˜ë°©**:
                               - ì¸ë„¤ì¼ì„ ê³ ì³ì•¼ í• ê¹Œìš”? (íƒìƒ‰ ìœ ì… ì €ì¡° ì‹œ)
                               - ë„ì…ë¶€ ë©˜íŠ¸ë¥¼ ê³ ì³ì•¼ í• ê¹Œìš”? (ì´ˆë°˜ ì´íƒˆ ì‹œ)
                               - ìƒí’ˆì„ ë°”ê¿”ì•¼ í• ê¹Œìš”? (ìˆ˜ìµ ì €ì¡° ì‹œ)
                               - í•œ ì¤„ë¡œ ëª…í™•í•œ í–‰ë™ ì§€ì¹¨ì„ ì£¼ì„¸ìš”.

                            **ì¶œë ¥ í˜•ì‹:**
                            ### ğŸ©º Gemini 3.0 ì§„ë‹¨ ë¦¬í¬íŠ¸
                            - **íŠ¸ë˜í”½ ìœ í˜•**: [íƒìƒ‰í˜• / í”¼ë“œí˜•] (ë¹„ìœ¨ ëª…ì‹œ)
                            - **ì‹œì²­ ìœ ì§€ë ¥**: [ì´ˆë°˜ ì´íƒˆ / ì™„ë§Œí•¨ / ë–¡ìƒí˜•]
                            - **ì¢…í•© ë“±ê¸‰**: **[ë“±ê¸‰]**
                            - **ì†”ë£¨ì…˜**: [êµ¬ì²´ì ì¸ í–‰ë™ ì§€ì¹¨ í•œ ì¤„]
                            """
                            
                            response = model.generate_content([vision_prompt, image])
                            st.markdown(response.text)
                            
                        except Exception as e:
                            st.error(f"ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
                            st.info("â€» 3.0 ëª¨ë¸ì´ ì•„ì§ í”„ë¦¬ë·°ë¼ ë¶ˆì•ˆì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ê³„ì†ë˜ë©´ 1.5 Proë¡œ ë³€ê²½ì„ ê³ ë ¤í•˜ì„¸ìš”.")
            
            # ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
            my_bar.progress((i + 1) / len(uploaded_files), text=f"{i+1}/{len(uploaded_files)} ì™„ë£Œ...")
        
        st.balloons()
        st.success("âœ… ëª¨ë“  ë¶„ì„ì´ ëë‚¬ìŠµë‹ˆë‹¤! ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.")