import streamlit as st
from google import genai
from PIL import Image
import os
import time  # ì†ë„ ì¡°ì ˆìš©

# ---------------------------------------------------------
# 1. í˜ì´ì§€ ì„¤ì •
# ---------------------------------------------------------
st.set_page_config(page_title="ì‡¼í•‘ ì‡¼ì¸  í•´ì»¤ (í•˜ì´ë¸Œë¦¬ë“œ)", page_icon="ğŸš€", layout="wide")

# ---------------------------------------------------------
# 2. API í‚¤ ìë™ ê°ì§€
# ---------------------------------------------------------
api_key = None

if "GOOGLE_API_KEY" in st.secrets:
    api_key = st.secrets["GOOGLE_API_KEY"]
    with st.sidebar:
        st.success("ğŸ”‘ ì‚¬ì¥ë‹˜ ìë™ ë¡œê·¸ì¸ ì™„ë£Œ")
        st.write("Engine: **Hybrid (Flash + Pro)**")
else:
    with st.sidebar:
        st.header("âš™ï¸ ì„¤ì •")
        api_key = st.text_input("Google Gemini API Key", type="password")

if not api_key:
    st.warning("ğŸ‘ˆ API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.")
    st.stop()

try:
    client = genai.Client(api_key=api_key)
except Exception as e:
    st.error(f"í´ë¼ì´ì–¸íŠ¸ ì—°ê²° ì˜¤ë¥˜: {e}")
    st.stop()

# ---------------------------------------------------------
# 3. ë©”ì¸ í™”ë©´
# ---------------------------------------------------------
st.title("ğŸ“Š ìœ íŠœë¸Œ ì‡¼í•‘ ì‡¼ì¸  ì •ë°€ ì§„ë‹¨ê¸°")
st.markdown("### **Flash(ì†ë„)**ë¡œ ì½ê³  **Pro(ì§€ëŠ¥)**ë¡œ ì»¨ì„¤íŒ…í•©ë‹ˆë‹¤.")
st.info("ğŸ’¡ 'ì†ë„ ì œí•œ(429 Error)'ì„ ìš°íšŒí•˜ëŠ” **í•˜ì´ë¸Œë¦¬ë“œ ê¸°ìˆ **ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.")
st.markdown("---")

uploaded_files = st.file_uploader(
    "ë¶„ì„í•  ìº¡ì²˜ ì´ë¯¸ì§€ë¥¼ ëª¨ë‘ ë“œë˜ê·¸í•˜ì„¸ìš” (ëŒ€ëŸ‰ ê°€ëŠ¥)", 
    type=["jpg", "png", "jpeg"], 
    accept_multiple_files=True
)

if uploaded_files:
    st.success(f"ğŸ“¸ {len(uploaded_files)}ì¥ì˜ ë°ì´í„°ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.")
    
    if st.button("ğŸš€ í•˜ì´ë¸Œë¦¬ë“œ ì§„ë‹¨ ì‹œì‘", type="primary"):
        
        all_analysis_results = []
        
        progress_text = "Flash ì—”ì§„ì´ ë¹ ë¥´ê²Œ ë°ì´í„°ë¥¼ ìˆ˜ì§‘ ì¤‘ì…ë‹ˆë‹¤..."
        my_bar = st.progress(0, text=progress_text)
        
        # -----------------------------------------------------
        # [1ë‹¨ê³„] ê°œë³„ ì´ë¯¸ì§€ ë¶„ì„ (Flash ëª¨ë¸ ì‚¬ìš© - ì œí•œ ì—†ìŒ)
        # -----------------------------------------------------
        for i, uploaded_file in enumerate(uploaded_files):
            
            with st.expander(f"ğŸ“„ {i+1}ë²ˆ ë°ì´í„° ì¶”ì¶œ ({uploaded_file.name})", expanded=False):
                col_img, col_report = st.columns([1, 1.5])
                
                image = Image.open(uploaded_file)
                with col_img:
                    st.image(image, caption=f"ë°ì´í„° {i+1}", use_container_width=True)
                
                with col_report:
                    try:
                        # ë‹¨ìˆœ ë¶„ì„ì€ Flashì—ê²Œ ë§¡ê¹ë‹ˆë‹¤ (ì–˜ëŠ” ì œí•œì´ ê±°ì˜ ì—†ìŠµë‹ˆë‹¤)
                        vision_prompt = """
                        ì´ ì´ë¯¸ì§€ëŠ” ìœ íŠœë¸Œ ìŠ¤íŠœë””ì˜¤ ë¶„ì„í‘œì…ë‹ˆë‹¤.
                        ë‹¤ìŒ 3ê°€ì§€ ë°ì´í„°ë§Œ ì§§ê³  ê±´ì¡°í•˜ê²Œ ì¶”ì¶œí•˜ì„¸ìš”:
                        1. íŠ¸ë˜í”½ ì†ŒìŠ¤ ë¹„ìœ¨ (íƒìƒ‰ vs í”¼ë“œ)
                        2. ì‹œì²­ ì§€ì†ë¥  ê·¸ë˜í”„ íŠ¹ì§• (ì´ˆë°˜ ì´íƒˆ ì—¬ë¶€)
                        3. ì‡¼í•‘ ìˆ˜ìµ ì„±ê³¼
                        """
                        
                        response = client.models.generate_content(
                            model="gemini-1.5-flash",
                            contents=[vision_prompt, image]
                        )
                        
                        st.markdown(response.text)
                        all_analysis_results.append(f"[{uploaded_file.name} ë°ì´í„°]: {response.text}")
                        
                    except Exception as e:
                        st.error(f"ì˜¤ë¥˜: {e}")
            
            # êµ¬ê¸€ ì„œë²„ë¥¼ ë°°ë ¤í•´ì„œ 1ì´ˆì”© ì‰¬ì–´ì¤ë‹ˆë‹¤ (ì•ˆì „ì¥ì¹˜)
            time.sleep(1)
            my_bar.progress((i + 1) / len(uploaded_files))
        
        # -----------------------------------------------------
        # [2ë‹¨ê³„] ì¢…í•© ê²°ë¡  (ì—¬ê¸°ì„œ 2.5 Pro ë“±íŒ!)
        # -----------------------------------------------------
        st.markdown("---")
        st.header("ğŸ“ Gemini 2.5 Pro ì¢…í•© ì»¨ì„¤íŒ…")
        st.caption("â€» ìœ„ì—ì„œ ìˆ˜ì§‘í•œ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ **ìµœê³  ì„±ëŠ¥ AI**ê°€ ìµœì¢… ì „ëµì„ ì§­ë‹ˆë‹¤.")
        
        with st.spinner("Pro AIê°€ ë‡Œë¥¼ í’€ê°€ë™ ì¤‘ì…ë‹ˆë‹¤... (ì ì‹œë§Œ ê¸°ë‹¤ë¦¬ì„¸ìš”)"):
            try:
                combined_data = "\n".join(all_analysis_results)
                
                final_prompt = f"""
                ë‹¹ì‹ ì€ ëŒ€í•œë¯¼êµ­ ìµœê³ ì˜ ìœ íŠœë¸Œ ì‡¼í•‘ ì±„ë„ ì»¨ì„¤í„´íŠ¸ì…ë‹ˆë‹¤.
                ì•„ë˜ ë‚´ìš©ì€ ì´ ì±„ë„ì˜ ì˜ìƒ {len(uploaded_files)}ê°œì— ëŒ€í•œ ë¶„ì„ ë°ì´í„°ì…ë‹ˆë‹¤.
                
                ì´ ë°ì´í„°ë¥¼ **í†µí‹€ì–´ì„œ ë´¤ì„ ë•Œ** ë°œê²¬ë˜ëŠ” íŒ¨í„´ê³¼ ë¬¸ì œì ì„ ì°¾ì•„ë‚´ê³ ,
                ì±„ë„ ì£¼ì¸ì—ê²Œ ì•„ì£¼ ê¼¼ê¼¼í•˜ê³  ì§ì„¤ì ì¸ í”¼ë“œë°±ì„ ì‘ì„±í•˜ì„¸ìš”.

                **[ìˆ˜ì§‘ëœ ë°ì´í„° ëª¨ìŒ]**
                {combined_data}

                **[ì‘ì„± ê°€ì´ë“œ]**
                1. **ğŸ©º í˜„ì¬ ìƒíƒœ ì •ë°€ ì§„ë‹¨ (Fact Check)**:
                   - ì „ì²´ì ìœ¼ë¡œ 'í”¼ë“œ ë…¸ì¶œ' ìœ„ì£¼ì¸ê°€, 'íƒìƒ‰ ìœ ì…' ìœ„ì£¼ì¸ê°€?
                   - ëˆì„ ë²Œì–´ë‹¤ ì¤€ ì˜ìƒë“¤ì˜ ê³µí†µì ì¸ 'ì„±ê³µ ê³µì‹'ì€ ë¬´ì—‡ì¸ê°€?
                   - ì¡°íšŒìˆ˜ëŠ” ë†’ì€ë° ëˆ ëª» ë²ˆ ì˜ìƒë“¤ì˜ 'íŒ¨ì°©'ì€ ë¬´ì—‡ì¸ê°€?

                2. **ğŸ‘ ì¹­ì°¬í•´ì¤„ ì  (Keep)**:
                   - ë°ì´í„°ì—ì„œ ë°œê²¬ëœ ê¸ì •ì ì¸ ì‹ í˜¸ì™€ ê³„ì† ìœ ì§€í•´ì•¼ í•  ì „ëµ.

                3. **ğŸ”ª ë¼ˆ ë•Œë¦¬ëŠ” ì§€ì  (Stop)**:
                   - ì¸ë„¤ì¼/ì œëª© íŒ¨í„´ì˜ ë¬¸ì œì .
                   - ì´ˆë°˜ 3ì´ˆ í›„í‚¹ ë°©ì‹ì˜ ë¬¸ì œì .
                   - ìƒí’ˆ ì„ ì •ê³¼ ì˜ìƒì˜ ë¶€ì¡°í™” ë“±ì„ ì ë‚˜ë¼í•˜ê²Œ ì§€ì í•˜ì„¸ìš”.

                4. **ğŸš€ ë‹¹ì¥ í•´ì•¼ í•  í–‰ë™ ê°•ë ¹ (Action Plan)**:
                   - "ë‚´ì¼ë¶€í„° ì œëª©ì„ OOí•˜ê²Œ ë°”ê¾¸ì„¸ìš”"
                   - "ì¸ë„¤ì¼ì— OOì„ ë„£ìœ¼ì„¸ìš”"
                   - êµ¬ì²´ì ì´ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ì§€ì¹¨ 3ê°€ì§€ë¥¼ ë‚´ë¦¬ì„¸ìš”.

                ë§íˆ¬ëŠ” ì „ë¬¸ê°€ë‹µê²Œ, í™•ì‹ ì— ì°¨ê³  ëƒ‰ì² í•˜ê²Œ ì‘ì„±í•˜ì„¸ìš”.
                """
                
                # ğŸ”¥ [í•µì‹¬] ìµœì¢… íŒë‹¨ì€ ì‚¬ì¥ë‹˜ì´ ì›í•˜ì‹  'gemini-1.5-pro-002' (2.5 Proê¸‰) ì‚¬ìš©!
                # í…ìŠ¤íŠ¸ ì²˜ë¦¬ëŠ” ì´ë¯¸ì§€ ì²˜ë¦¬ë³´ë‹¤ ì œí•œì´ ëœí•´ì„œ ì—¬ê¸°ì„œ í„°ì§ˆ í™•ë¥ ì€ ë‚®ìŠµë‹ˆë‹¤.
                final_response = client.models.generate_content(
                    model="gemini-1.5-pro-002",
                    contents=final_prompt
                )
                
                st.markdown(final_response.text)
                
            except Exception as e:
                st.error(f"ì¢…í•© ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
                st.info("í˜¹ì‹œë¼ë„ ì—¬ê¸°ì„œ ì—ëŸ¬ê°€ ë‚˜ë©´ 1ë¶„ ë’¤ì— ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”. (êµ¬ê¸€ ì œí•œ)")

        st.balloons()